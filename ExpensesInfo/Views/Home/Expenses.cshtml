@using ExpensesInfo.Models;
@model List<Expense>
@{
    ViewData["Title"] = "Expenses";
}
<div class="text-center">
    <h1 class=" display-4">Expenses</h1>
</div>
<hr />
<form method="get" class="row mb-3">
    <div class="col-md-4">
        <select name="typeId" class="form-select">
            <option value="">-- All types --</option>
            @foreach (var t in (List<ExpenseType>)ViewBag.Types)
            {
                if (ViewBag.SelectedTypeId != null && ViewBag.SelectedTypeId == t.Id)
                {
                    <option value="@t.Id" selected="selected">@t.Name</option>
                }
                else
                {
                    <option value="@t.Id">@t.Name</option>
                }
            }
        </select>
    </div>
    <div class="col-md-2">
        <button class="btn btn-secondary w-100" type="submit">Filter</button>
    </div>
    <div class="col-md-6 text-end">
        <a class="btn btn-success" asp-action="CreateEditExpense">Add expense</a>
    </div>
</form>
<hr />
<h3>Total expenses: $@ViewBag.TotalExpenses</h3>
<hr />
<p>
    <a class="btn btn-success" asp-action="CreateEditExpense">Add expense</a>
</p>
<div class="mb-3">
    <input type="text" class="form-control" id="searchDescription" placeholder="Search in descriptions...">
</div>
<table class="table">
    <thead>
        <tr>
            <th>Id</th>
            <th title="Сума в лева с 2 десетични">Value</th>
            <th>Description</th>
            <th>Type</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Count > 0)
        {
            foreach (var expense in Model)
            {
                <tr class="@(expense.Value > 100 ? "high-expense" : "")">
                    <td>@expense.Id</td>
                    <td>@expense.Value</td>
                    <td>@expense.Description</td>
                    <td>@expense.ExpenseType?.Name</td>
                    <td>
                        <a class="btn btn-primary" asp-action="CreateEditExpense" asp-route-id="@expense.Id">Edit</a>
                        <a class="btn btn-danger" asp-action="DeleteExpense" asp-route-id="@expense.Id"
                           onclick="return confirm('Are you sure?');">Delete</a>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>
</div>


@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const searchInput = document.getElementById("searchDescription");
            const rows = document.querySelectorAll("tbody tr");
            let timeout;

            searchInput.addEventListener("input", function () {
                clearTimeout(timeout);

                timeout = setTimeout(() => {
                    const filter = searchInput.value.toLowerCase();

                    rows.forEach(row => {
                        const description = row.cells[2].innerText.toLowerCase(); // Description е в 3-та колона
                        if (description.includes(filter)) {
                            row.style.display = "";
                        } else {
                            row.style.display = "none";
                        }
                    });
                }, 300); // 300ms debounce
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const table = document.querySelector("table");
            if (!table) return;

            const tbody = table.querySelector("tbody");
            const headers = table.querySelectorAll("th");

            headers.forEach((th, index) => {
                if ([1, 2, 3].includes(index)) { // Value, Description, Type
                    let asc = true;
                    th.style.cursor = "pointer";

                    th.addEventListener("click", () => {
                        const rowsArray = Array.from(tbody.querySelectorAll("tr")).filter(r => r.style.display !== "none");

                        rowsArray.sort((a, b) => {
                            let aText = a.cells[index].innerText.trim();
                            let bText = b.cells[index].innerText.trim();

                            if (index === 1) { // числова колона Value
                                aText = parseFloat(aText) || 0;
                                bText = parseFloat(bText) || 0;
                            } else { // текстова колона
                                aText = aText.toLowerCase();
                                bText = bText.toLowerCase();
                            }

                            if (aText > bText) return asc ? 1 : -1;
                            if (aText < bText) return asc ? -1 : 1;
                            return 0;
                        });

                        rowsArray.forEach(row => tbody.appendChild(row));
                        asc = !asc;
                    });
                }
            });
        });
    </script>
}

